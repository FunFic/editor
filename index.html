<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FunFic Editor</title>
  <script src="js/popper.min.js" type="text/javascript" charset="utf-8"></script>
  <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet">
  <script src="js/bootstrap/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/beautify.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/pegParser.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/pegReverser.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/injection.js" type="text/javascript" charset="utf-8"></script>
  <link href="css/styles.css" rel="stylesheet">
</head>

<body class="funfic">
<div class="container-fluid">
  <div class="row">
    <div class="col col-auto p-0">
      <nav class="menu">
        <ol>
          <li><a href="#" id="newBtn" data-bs-toggle="tooltip" data-bs-placement="right" title="Novo Documento">Novo Documento</a></li>
          <li><a href="#" id="backgroundBtn" data-bs-toggle="tooltip" data-bs-placement="right" title="Alterar cor de Fundo">Fundo</a></li>
          <li><a href="#" id="textBtn" data-bs-toggle="tooltip" data-bs-placement="right" title="Adicionar Texto">Texto</a></li>
          <li><a href="#" id="imageBtn" data-bs-toggle="tooltip" data-bs-placement="right" title="Adicionar Imagem">Imagem</a></li>
          <li><a href="#" id="drawBtn" data-bs-toggle="tooltip" data-bs-placement="right" title="Criar ferramenta de desenho">Desenho</a></li>
          <li><a href="#" id="bubbleBtn" data-bs-toggle="tooltip" data-bs-placement="right" title="Adicionar balão de texto">Balão</a></li>
          <li><a href="#" id="helpBtn" data-bs-toggle="tooltip" data-bs-placement="right" title="Obter ajuda">Ajuda</a></li>
          <li><a href="#" id="saveBtn" data-bs-toggle="tooltip" data-bs-placement="right" title="Salvar">Salvar</a></li>
          <!--<li><a href="javascript:addText();">Text</a></li>
          <li><a href="javascript:addCircle();">Circle</a></li>
          <li><a href="javascript:valida();">Valida</a></li>-->
        </ol>
      </nav>
    </div><!--col-->
    <div class="col p-0" id="editor">function setup() {
    createCanvas(windowWidth, windowHeight);
    background(0)
}

function draw() {
    ellipse(mouseX, mouseY, 10, 10);
}</div><!--col-->
    <div class="col col-12 col-md-6 p-0">
      <iframe id="result" src="result.html"></iframe>
    </div><!--col-->
  </div><!--row-->
</div><!--container-->

<div class="modal fade" id="popup" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="popupTitle">
          <!--dynamic content-->
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>  
      <div class="modal-body" id="popupBody">
        <!--dynamic content-->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="popupConfirm">Confirmar</button>
      </div>
    </div>
  </div>
</div>
</body>
<script>

  /*
  Editor
  */
  var editor = ace.edit("editor");
  var resultFrame = document.getElementById("result");
  var prevValue, prevCursor;

  editor.setTheme("ace/theme/dracula");
  editor.session.setMode("ace/mode/javascript");
  editor.setOptions({fontSize: "14pt"});
  
  editor.session.on('change', function(delta) {
      // delta.start, delta.end, delta.lines, delta.action
      resultFrame.contentWindow.location.reload();
  });

  resultFrame.onload = function() {
    resultFrame.contentWindow.postMessage({type:"newCode", code:editor.getValue()});
  };

  /*
  Tooltips
  */
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })

  /*
  iFrame message receiver
  */
  var imageLoaded;//store temporary function

  /*
  Popup
  */
  var popupEl = document.getElementById('popup');
  var popup = new bootstrap.Modal(popupEl);
  var popupTitleEl = document.getElementById('popupTitle');
  var popupBodyEl = document.getElementById('popupBody');
  var popupConfirmEl = document.getElementById('popupConfirm');
  popupEl.addEventListener('show.bs.modal', function (event) {
    prevValue = editor.getValue();
    prevCursor = editor.selection.getCursor();
  });
  popupEl.addEventListener('hide.bs.modal', reset);
  popupConfirmEl.addEventListener('click', function (event) {
    prevValue = editor.getValue();
    prevCursor = editor.selection.getCursor();
    popup.hide();
  });

  function reset(){
    editor.setValue(prevValue);
    editor.navigateTo(prevCursor.row, prevCursor.column);
  }

  /*
  Widgets
  */
  function showPopup(title, body){
    popupTitleEl.innerHTML = title;
    popupBodyEl.innerHTML = body;
    popup.show();
  }

  //New
  var newBtnEl = document.getElementById('newBtn');
  newBtnEl.addEventListener('click', function (event) {
    event.preventDefault();

    showPopup("Novo", `
    <div class="container-fluid container-buttons">
      <div class="row">
        <div class="col-sm-4"><div class="btn">Fanfic com fundo</div></div>
        <div class="col-sm-4"><div class="btn">Personagem com balão</div></div>
        <div class="col-sm-4"><div class="btn">Meme</div></div>
        <div class="col-sm-4"><div class="btn">Desenho livre</div></div>
        <div class="col-sm-4"><div class="btn">Limpo</div></div>
        <div class="col-sm-4"><div class="btn">Ajuda</div></div>
      </div>
    </div>
    `);
  });

  //Background
  var backgroundBtnEl = document.getElementById('backgroundBtn');
  backgroundBtnEl.addEventListener('click', function (event) {
    event.preventDefault();

    showPopup("Cor de Fundo", `
    <label for="widgetBackgroundR" class="form-label">Vermelho</label>
    <input type="range" class="form-range" min="0" max="255" id="widgetBackgroundR">
    <label for="widgetBackgroundG" class="form-label">Verde</label>
    <input type="range" class="form-range" min="0" max="255" id="widgetBackgroundG">
    <label for="widgetBackgroundB" class="form-label">Azul</label>
    <input type="range" class="form-range" min="0" max="255" id="widgetBackgroundB">
    `);

    var widgetBackgroundREl = document.getElementById('widgetBackgroundR');
    var widgetBackgroundGEl = document.getElementById('widgetBackgroundG');
    var widgetBackgroundBEl = document.getElementById('widgetBackgroundB');
    widgetBackgroundREl.addEventListener('change', event => update());
    widgetBackgroundGEl.addEventListener('change', event => update());
    widgetBackgroundBEl.addEventListener('change', event => update());

    function update(){
      reset();
      var r = widgetBackgroundREl.value;
      var g = widgetBackgroundGEl.value;
      var b = widgetBackgroundBEl.value;
      if(injector.commandExists(editor.getValue(), "background")){
        editor.setValue(
          js_beautify(
            injector.updateCommand(editor.getValue(), "background", `background(${r}, ${g}, ${b})`)
          )
        );
      }else{
        addToFunction("draw", `background(${r}, ${g}, ${b})`);
      }
    }
    update();
  });

  //Texto
  var textBtnEl = document.getElementById('textBtn');
  textBtnEl.addEventListener('click', function (event) {
    event.preventDefault();

    showPopup("Texto", `
    <label for="widgetTextText" class="form-label">Texto</label>
    <textarea class="form-control" id="widgetTextText" rows="3">Meu texto</textarea>
    <label for="widgetTextFont" class="form-label">Fonte</label>
    <select class="form-select" id="widgetTextFont">
      <option>Arial</option>
      <option>Courier New</option>
      <option>Georgia</option>
      <option>Times New Roman</option>
      <option>Trebuchet MS</option>
      <option>Verdana</option>
    </select>
    <label for="widgetTextX" class="form-label">X</label>
    <input type="range" class="form-range" min="0" max="500" id="widgetTextX">
    <label for="widgetTextY" class="form-label">Y</label>
    <input type="range" class="form-range" min="0" max="500" id="widgetTextY">
    <label for="widgetTextSize" class="form-label">Tamanho</label>
    <input type="range" class="form-range" min="10" max="100" id="widgetTextSize">
    <label for="widgetTextR" class="form-label">Vermelho</label>
    <input type="range" class="form-range" min="0" max="255" id="widgetTextR">
    <label for="widgetTextG" class="form-label">Verde</label>
    <input type="range" class="form-range" min="0" max="255" id="widgetTextG">
    <label for="widgetTextB" class="form-label">Azul</label>
    <input type="range" class="form-range" min="0" max="255" id="widgetTextB">
    `);

    var widgetTextTextEl = document.getElementById('widgetTextText');
    var widgetTextXEl = document.getElementById('widgetTextX');
    var widgetTextYEl = document.getElementById('widgetTextY');
    var widgetTextSizeEl = document.getElementById('widgetTextSize');
    var widgetTextFontEl = document.getElementById('widgetTextFont');
    var widgetTextREl = document.getElementById('widgetTextR');
    var widgetTextGEl = document.getElementById('widgetTextG');
    var widgetTextBEl = document.getElementById('widgetTextB');
    widgetTextTextEl.addEventListener('change', event => update());
    widgetTextTextEl.addEventListener('input', event => update());     
    widgetTextXEl.addEventListener('change', event => update());
    widgetTextYEl.addEventListener('change', event => update());
    widgetTextSizeEl.addEventListener('change', event => update());
    widgetTextFontEl.addEventListener('change', event => update());
    widgetTextREl.addEventListener('change', event => update());
    widgetTextGEl.addEventListener('change', event => update());
    widgetTextBEl.addEventListener('change', event => update());

    function update(){
      reset();
      addToFunction("draw", `
      textFont("${widgetTextFontEl.value}")
      textSize(${widgetTextSizeEl.value})
      fill(${widgetTextREl.value}, ${widgetTextGEl.value}, ${widgetTextBEl.value})
      text("${widgetTextTextEl.value.replace(/\n/g, '\\\\n')}", ${widgetTextXEl.value}, ${widgetTextYEl.value});`);
    }
    update();
  });

  //Image
  var imageBtnEl = document.getElementById('imageBtn');
  imageBtnEl.addEventListener('click', function (event) {
    event.preventDefault();

    showPopup("Imagem", `
    <div class="form-group">
      <label for="widgetImageFile">Imagem</label>
      <input type="file" class="form-control-file" id="widgetImageFile">
    </div>
    <label for="widgetImageX" class="form-label">X</label>
    <input type="range" class="form-range" min="0" max="500" id="widgetImageX">
    <label for="widgetImageY" class="form-label">Y</label>
    <input type="range" class="form-range" min="0" max="500" id="widgetImageY">
    <label for="widgetImageScale" class="form-label">Escala</label>
    <input type="range" class="form-range" min="0" max="3" value="1" step="0.01" id="widgetImageScale">
    `);

    var widgetImageFileEl = document.getElementById('widgetImageFile');
    var widgetImageXEl = document.getElementById('widgetImageX');
    var widgetImageYEl = document.getElementById('widgetImageY');
    var widgetImageScaleEl = document.getElementById('widgetImageScale');
    widgetImageXEl.addEventListener('change', event => update());
    widgetImageYEl.addEventListener('change', event => update());
    widgetImageScaleEl.addEventListener('change', event => update());

    var base64data = "";
    widgetImageFileEl.addEventListener('change', event => {
      const [file] = widgetImageFileEl.files;
      if (file) {
        var url = URL.createObjectURL(file);
        var reader = new FileReader();
        reader.readAsDataURL(file); 
        reader.onloadend = function() {
          base64data = reader.result;            
          update();
        }
      }
    });

    function update(){
      reset();
      addToBegin(`var img
        function preload(){
            var raw = new Image()
            raw.src='${base64data}'
            raw.onload = function() {
                img = createImage(raw.width, raw.height)
                img.drawingContext.drawImage(raw, 0, 0)
            }
        }
      `)
      addToFunction("draw", `
        push()
          scale(${widgetImageScaleEl.value})
          if(img) image(img, ${widgetImageXEl.value}, ${widgetImageYEl.value})
        pop()
      `);
    }
    update();
  });

  //Desenho
  var drawBtnEl = document.getElementById('drawBtn');
  drawBtnEl.addEventListener('click', function (event) {
    event.preventDefault();

    showPopup("Desenho", `
    <label for="widgetDrawSize" class="form-label">Tamanho</label>
    <input type="range" class="form-range" min="10" max="100" id="widgetDrawSize">
    <label for="widgetDrawR" class="form-label">Vermelho</label>
    <input type="range" class="form-range" min="0" max="255" id="widgetDrawR">
    <label for="widgetDrawG" class="form-label">Verde</label>
    <input type="range" class="form-range" min="0" max="255" id="widgetDrawG">
    <label for="widgetDrawB" class="form-label">Azul</label>
    <input type="range" class="form-range" min="0" max="255" id="widgetDrawB">
    `);
    
    var widgetDrawSizeEl = document.getElementById('widgetDrawSize');
    var widgetDrawREl = document.getElementById('widgetDrawR');
    var widgetDrawGEl = document.getElementById('widgetDrawG');
    var widgetDrawBEl = document.getElementById('widgetDrawB');
    widgetDrawREl.addEventListener('change', event => update());
    widgetDrawGEl.addEventListener('change', event => update());
    widgetDrawBEl.addEventListener('change', event => update());

    function update(){
      reset();
      addToFunction("draw", `
        if(mouseIsPressed){
            strokeWeight(${widgetDrawSizeEl.value})
            stroke(${widgetDrawREl.value}, ${widgetDrawGEl.value}, ${widgetDrawBEl.value})
            line(pmouseX, pmouseY, mouseX, mouseY)
        }`);
    }
    update();
  });

  //Bubble
  var bubbleBtnEl = document.getElementById('bubbleBtn');
  bubbleBtnEl.addEventListener('click', function (event) {
    event.preventDefault();

    showPopup("Balão de Texto", `
    <label for="widgetBubbleText" class="form-label">Texto</label>
    <textarea class="form-control" id="widgetBubbleText" rows="3">Meu texto</textarea>
    <label for="widgetBubbleFont" class="form-label">Fonte</label>
    <select class="form-select" id="widgetBubbleFont">
      <option>Arial</option>
      <option>Courier New</option>
      <option>Georgia</option>
      <option>Times New Roman</option>
      <option>Trebuchet MS</option>
      <option>Verdana</option>
    </select>
    <label for="widgetBubbleX" class="form-label">X</label>
    <input type="range" class="form-range" min="0" max="500" id="widgetBubbleX">
    <label for="widgetBubbleY" class="form-label">Y</label>
    <input type="range" class="form-range" min="0" max="500" id="widgetBubbleY">
    <label for="widgetBubbleSize" class="form-label">Tamanho</label>
    <input type="range" class="form-range" min="10" max="100" id="widgetBubbleSize">
    <label for="widgetBubbleDirection" class="form-label">Direção</label>
    <select class="form-select" id="widgetBubbleDirection">
      <option>Abaixo</option>
      <option>Acima</option>
      <option>Direita</option>
      <option>Esquerda</option>
    </select>
    `);

    var widgetBubbleTextEl = document.getElementById('widgetBubbleText');
    var widgetBubbleXEl = document.getElementById('widgetBubbleX');
    var widgetBubbleYEl = document.getElementById('widgetBubbleY');
    var widgetBubbleSizeEl = document.getElementById('widgetBubbleSize');
    var widgetBubbleDirectionEl = document.getElementById('widgetBubbleDirection');
    var widgetBubbleFontEl = document.getElementById('widgetBubbleFont');
    widgetBubbleTextEl.addEventListener('change', event => update());
    widgetBubbleTextEl.addEventListener('input', event => update());     
    widgetBubbleXEl.addEventListener('change', event => update());
    widgetBubbleYEl.addEventListener('change', event => update());
    widgetBubbleSizeEl.addEventListener('change', event => update());
    widgetBubbleDirectionEl.addEventListener('change', event => update());
    widgetBubbleFontEl.addEventListener('change', event => update());

    function update(){
      reset();
      if(!injector.functionExists(editor.getValue(), "desenhaBalao"))
      addToBegin(`function desenhaBalao(texto, direcao, font, tamanho, x, y) {
        textFont(font)
        textSize(tamanho)
        textLeading(tamanho)
        textAlign(LEFT, TOP)
        var linhas = texto.split("\\n")
        var larguras = linhas.map(function(t) {
          return textWidth(t) 
        });
        var largura = Math.max.apply(Math, larguras);
        var altura = linhas.length * tamanho;
        var espaco = 10;
        noStroke()
        fill(255)
        rect(x, y, largura + espaco * 2, altura + espaco * 2, 10, 10, 10, 10)

        if (direcao == "Acima") {
          triangle(x + 10, y, x + 50, y, x + 30, y - 20)
        } else if (direcao == "Abaixo") {
          triangle(x + 10, y + altura + espaco * 2, x + 50, y + altura + espaco * 2, x + 30, y + altura + 20 + espaco * 2)
        } else if (direcao == "Direita") {
          triangle(x, y + 10, x, y + 50, x - 20, y + 30)
        } else if (direcao == "Esquerda") {
          triangle(x + largura + espaco * 2, y + 10, x + largura + espaco * 2, y + 50, x + largura + espaco * 2 + 20, y + 30)
        }
        
        fill(0)
        text(texto, x + espaco, y + espaco)
      }

      `);

      addToFunction("draw", `desenhaBalao("${widgetBubbleTextEl.value.replace(/\n/g, '\\\\n')}", "${widgetBubbleDirectionEl.value}", "${widgetBubbleFontEl.value}", ${widgetBubbleSizeEl.value}, ${widgetBubbleXEl.value}, ${widgetBubbleYEl.value});`);
    }
    update();
  });

  //Ajuda
  var helpBtnEl = document.getElementById('helpBtn');
  helpBtnEl.addEventListener('click', function (event) {
    event.preventDefault();

    showPopup("Ajuda", `
    <div class="accordion" id="accordionExample">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            Accordion Item #1
          </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <strong>This is the first item's accordion body.</strong> It is shown by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It's also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingTwo">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            Accordion Item #2
          </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <strong>This is the second item's accordion body.</strong> It is hidden by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It's also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingThree">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
            Accordion Item #3
          </button>
        </h2>
        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <strong>This is the third item's accordion body.</strong> It is hidden by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It's also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.
          </div>
        </div>
      </div>
    </div>
    `);
  });

  //Salvar
  var saveBtnEl = document.getElementById('saveBtn');
  saveBtnEl.addEventListener('click', function (event) {
    event.preventDefault();

    showPopup("Salvar", `
    <div class="container-fluid container-buttons">
      <div class="row">
        <div class="col-sm-6"><div class="btn" id="widgetSaveSaveCode">Salvar código</div></div>
        <div class="col-sm-6"><div class="btn" id="widgetSaveSaveImage">Salvar imagem</div></div>
        <div><div class="btn" id="widgetSaveShare">Compartilhar Imagem</div></div>
      </div>
      <div class="row">
        Compartilhe nas suas redes sociais usando #FunFic
      </div>
    </div>
    `);

    function download(text, createBlobURL, name, type) {
      console.log(text);
      var a = document.createElement('a');
      if(createBlobURL){
        var file = new Blob([text], {type: type});
        a.setAttribute('href', URL.createObjectURL(file));
      }else{
        a.setAttribute('href', text);
      }
      a.setAttribute('download', name);
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function urltoFile(url, filename, mimeType){
        return (fetch(url)
            .then(function(res){return res.arrayBuffer();})
            .then(function(buf){return new File([buf], filename,{type:mimeType});})
        );
    }

    function onLoadToSave(imageData){
      urltoFile(imageData, 'funfic.jpg','image/jpeg')
        .then(file => { 
          download(imageData, false, 'funfic.jpg', 'image/jpeg');
        });
    }

    function onLoadToShare(imageData){
      urltoFile(imageData, 'image.jpg','image/jpeg')
        .then(file => { 
          navigator.share({
            files: [file],
            text: 'Minha criação no #FunFic'
          })
          .then(() => console.log('Share was successful.'))
          .catch((error) => console.log('Sharing failed', error));
        });
    }

    var widgetSaveSaveCodeEl = document.getElementById('widgetSaveSaveCode');
    var widgetSaveSaveImageEl = document.getElementById('widgetSaveSaveImage');
    var widgetSaveShareEl = document.getElementById('widgetSaveShare');

    widgetSaveSaveCodeEl.addEventListener('click', event => {
      download(editor.getValue(), true, 'sketch.js', 'text/javascript')
    });
    
    widgetSaveSaveImageEl.addEventListener('click', event => {
      imageLoaded = onLoadToSave;
      resultFrame.contentWindow.postMessage({type:"getImage"});
    });

    if (navigator.canShare) {
      widgetSaveShareEl.addEventListener('click', event => {
        imageLoaded = onLoadToShare;
        resultFrame.contentWindow.postMessage({type:"getImage"});
      });
    } else {
      widgetSaveShareEl.style.display = "none";
      console.error(`Your system doesn't support sharing files.`);
    }
  });

  /*
  Injector
  */
  var injector = Injection();

  function addText(){
    addToFunction("draw", "text('Olá mundo', mouseX, mouseY)");
  }

  function addCircle(){
    addToFunction("draw", "circle(mouseX, mouseY, 100, 100)");
  }

  function addToBegin(code){
    editor.session.insert({row: 0, column: 0}, code);
  }

  function addToFunction(functionName, code){
    editor.setValue(
      js_beautify(
        injector.injectByFunctionName(
          editor.getValue(), functionName, code
        )
      )
    );
  }

  function valida(){
    var code = injector.validate(editor.getValue());
    editor.setValue(
      js_beautify(code)
    );
  }
</script>
</body>

</html>